<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#020617"/>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">

    <title id="page-title">Finanças Pro v39</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #f1f5f9; scroll-behavior: smooth; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        
        .card { background-color: #1e293b; border-radius: 1.5rem; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.4); padding: 1.25rem; border: 1px solid #334155; }
        
        /* Sistema de Páginas */
        .view-section { display: none; animation: slideUp 0.3s ease-out; }
        .view-section.active { display: block; }
        
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Barra de Navegação Inferior */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: #0f172a; border-top: 1px solid #334155; display: flex; justify-content: space-around; padding: 0.75rem 0.5rem; z-index: 100; backdrop-filter: blur(10px); padding-bottom: calc(0.75rem + env(safe-area-inset-bottom)); }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 0.25rem; color: #64748b; font-size: 0.65rem; font-weight: 700; cursor: pointer; transition: all 0.2s; }
        .nav-item.active { color: #3b82f6; }
        .nav-item i { width: 1.4rem; height: 1.4rem; }

        /* Itens de Lista Estilo App */
        .item-row { transition: all 0.2s ease; border-width: 2px; border-style: solid; border-radius: 1.25rem; background: #1e293b; position: relative; }
        .item-paid { background-color: rgba(16, 185, 129, 0.05); border-color: rgba(16, 185, 129, 0.2) !important; }
        .item-unpaid { background-color: rgba(239, 68, 68, 0.05); border-color: rgba(239, 68, 68, 0.2) !important; }
        
        .input-field { background-color: #0f172a; color: #f1f5f9; border: 1px solid #334155; border-radius: 0.75rem; padding: 0.5rem 0.75rem; width: 100%; transition: all 0.2s; font-size: 0.85rem; }
        .input-field:focus { border-color: #3b82f6; outline: none; }

        .bank-input-live { background: transparent; border: none; font-size: 1.75rem; font-weight: 900; color: #10b981; text-align: center; width: 100%; outline: none; padding: 0; }
        .bank-name-input { background: transparent; border: none; font-size: 0.7rem; font-weight: 900; color: #94a3b8; text-align: center; width: 100%; outline: none; text-transform: uppercase; letter-spacing: 0.05em; }

        .month-tab { padding: 0.6rem 1.2rem; border-radius: 2rem; transition: all 0.3s; opacity: 0.5; font-weight: 800; font-size: 0.75rem; white-space: nowrap; border: 1px solid transparent; }
        .active-month-tab { opacity: 1; background: #3b82f6; color: white; border-color: #60a5fa; box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3); }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Mini Toggle */
        .toggle-switch { position: relative; display: inline-flex; width: 38px; height: 20px; flex-shrink: 0; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #475569; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #10b981; }
        input:checked + .slider:before { transform: translateX(18px); }

        /* Badge do Banco */
        .bank-tag { font-size: 0.6rem; padding: 3px 8px; border-radius: 6px; font-weight: 900; background: #0f172a; border: 1px solid #334155; cursor: pointer; display: inline-block; min-width: 35px; text-align: center; }
        
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.85); z-index: 200; display: none; align-items: center; justify-content: center; padding: 1rem; backdrop-filter: blur(10px); }
    </style>
</head>
<body class="pb-32">

    <div id="save-indicator" class="fixed top-4 right-4 bg-emerald-500 text-white px-4 py-2 rounded-full text-xs font-bold hidden z-[300]">Sincronizado</div>

    <!-- Header Fixo -->
    <header class="p-6 pb-2">
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-2" onclick="editAppTitle()">
                <h1 id="app-display-title" class="text-xl font-black tracking-tighter uppercase">Finanças Pro</h1>
                <i data-lucide="pencil" class="w-3 h-3 text-blue-400"></i>
            </div>
            <div class="flex gap-2">
                <button onclick="openModal('settings-modal')" class="p-2 bg-slate-800 rounded-full text-slate-400"><i data-lucide="menu" class="w-5 h-5"></i></button>
            </div>
        </div>

        <!-- Abas de Meses (Scroll Horizontal) -->
        <div class="flex overflow-x-auto no-scrollbar gap-2 mb-2" id="month-tabs-container"></div>
    </header>

    <main class="px-6" id="main-content">
        <!-- Renderizado dinamicamente pelo changeView() -->
    </main>

    <!-- Navegação Inferior -->
    <nav class="bottom-nav">
        <div class="nav-item active" id="nav-overview" onclick="changeView('overview')">
            <i data-lucide="layout-dashboard"></i>
            <span>Resumo</span>
        </div>
        <div class="nav-item" id="nav-transactions" onclick="changeView('transactions')">
            <i data-lucide="receipt"></i>
            <span>Contas</span>
        </div>
        <div class="nav-item" id="nav-wallet" onclick="changeView('wallet')">
            <i data-lucide="wallet"></i>
            <span>Carteira</span>
        </div>
    </nav>

    <!-- Modal Global de Configurações -->
    <div id="settings-modal" class="modal-overlay">
        <div class="card w-full max-w-sm text-center">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-black uppercase">Menu do App</h2>
                <button onclick="closeModal('settings-modal')" class="p-2 hover:bg-slate-700 rounded-full"><i data-lucide="x"></i></button>
            </div>
            <div class="space-y-3">
                <button onclick="openModal('global-tool-modal'); closeModal('settings-modal');" class="btn btn-warning w-full py-4"><i data-lucide="zap"></i> Adição Recorrente</button>
                <button onclick="advanceTimeline()" class="btn btn-secondary w-full py-4 text-red-400"><i data-lucide="fast-forward"></i> Encerrar Mês Atual</button>
                <div class="border-t border-slate-700 pt-4 flex gap-2">
                    <button onclick="downloadBackup()" class="btn bg-slate-700 w-1/2 py-3">Exportar</button>
                    <input type="file" id="importFile" class="hidden" accept=".json" onchange="handleImport(this)">
                    <button onclick="document.getElementById('importFile').click()" class="btn bg-slate-700 w-1/2 py-3">Importar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Adição Global -->
    <div id="global-tool-modal" class="modal-overlay">
        <div class="card w-full max-w-lg">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-black text-yellow-400 uppercase">Item em Massa</h2>
                <button onclick="closeModal('global-tool-modal')" class="p-2 hover:bg-slate-700 rounded-full"><i data-lucide="x"></i></button>
            </div>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <input type="text" id="global-name" placeholder="Nome" class="input-field">
                    <input type="number" id="global-value" placeholder="Valor" class="input-field">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <select id="global-type" class="input-field">
                        <option value="fixed">Dívida Fixa</option>
                        <option value="variable">Dívida Variável</option>
                        <option value="income">Entrada</option>
                    </select>
                    <input type="date" id="global-date" class="input-field">
                </div>
                <button onclick="applyGlobalItem()" class="btn btn-primary w-full py-4 font-black">LANÇAR EM TODOS OS MESES</button>
            </div>
        </div>
    </div>

    <div id="cashflow-modal-overlay" class="modal-overlay">
        <div class="card w-full max-w-3xl max-h-[85vh] flex flex-col overflow-hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-black uppercase" id="cashflow-title">Fluxo de Caixa</h2>
                <button onclick="closeModal('cashflow-modal-overlay')" class="p-2 hover:bg-slate-700 rounded-full"><i data-lucide="x"></i></button>
            </div>
            <div class="overflow-y-auto pr-2 no-scrollbar" id="cashflow-content"></div>
        </div>
    </div>

    <div id="confirm-modal-overlay" class="modal-overlay">
        <div class="card w-full max-w-xs text-center">
            <h3 class="text-lg font-black mb-2 uppercase">Confirmar?</h3>
            <p class="text-slate-400 text-sm mb-6" id="confirm-body"></p>
            <div class="flex justify-center gap-3">
                <button id="confirm-btn-yes" class="btn btn-primary px-10">Sim</button>
                <button onclick="closeModal('confirm-modal-overlay')" class="btn btn-secondary">Não</button>
            </div>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'financialData_App_v39_final';
        const TITLE_KEY = 'financialApp_Title_v39';
        const HORA_EXTRA_RATE = 21;
        const MONTH_NAMES = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        
        let timeline = [];
        let activeIndex = 0;
        let currentView = 'overview';
        let globalChart = null;

        function initApp() {
            const savedTitle = localStorage.getItem(TITLE_KEY);
            if (savedTitle) { document.getElementById('app-display-title').innerText = savedTitle; }
            
            let saved = localStorage.getItem(STORAGE_KEY);
            if (!saved) saved = localStorage.getItem('financialData_App_v38_stable');
            
            if (saved) {
                timeline = JSON.parse(saved);
                migrateToV39();
            } else {
                createInitialTimeline();
            }
            renderAll();
        }

        function createInitialTimeline() {
            let now = new Date();
            let startMonth = now.getMonth();
            let startYear = now.getFullYear();
            timeline = [];
            for (let i = 0; i < 6; i++) {
                let mIdx = (startMonth + i) % 12;
                let yOff = Math.floor((startMonth + i) / 12);
                timeline.push({ 
                    label: MONTH_NAMES[mIdx], 
                    year: startYear + yOff, 
                    bank1Name: 'BANCO DO BRASIL',
                    bank2Name: 'MERCADO PAGO',
                    bank1Balance: 0, 
                    bank2Balance: 0,
                    data: createEmptyMonthData(mIdx, startYear + yOff) 
                });
            }
            saveData();
        }

        function createEmptyMonthData(mIdx, year) {
            const firstDay = new Date(year, mIdx, 1).toISOString().slice(0, 10);
            return {
                incomeEntries: [{ id: 'saldo-sys', name: 'Saldo Anterior', value: 0, isSystem: true, date: firstDay }],
                fixedExpensesEntries: [],
                variableExpensesEntries: []
            };
        }

        function migrateToV39() {
            timeline.forEach(m => {
                if (m.bank1Name === undefined) m.bank1Name = 'BANCO DO BRASIL';
                if (m.bank2Name === undefined) m.bank2Name = 'MERCADO PAGO';
                // Migração de chaves de versões v37/v38
                if (m.bankBB !== undefined) { m.bank1Balance = m.bankBB; delete m.bankBB; }
                if (m.bankMP !== undefined) { m.bank2Balance = m.bankMP; delete m.bankMP; }
                if (m.data) {
                    const all = [...(m.data.fixedExpensesEntries || []), ...(m.data.variableExpensesEntries || [])];
                    all.forEach(item => { 
                        if (item.source === undefined) item.source = 'B1';
                        // Normalização de fontes antigas
                        if (item.source === 'BB') item.source = 'B1';
                        if (item.source === 'MP') item.source = 'B2';
                    });
                }
            });
            saveData();
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(timeline));
            const indicator = document.getElementById('save-indicator');
            if (indicator) { indicator.classList.remove('hidden'); setTimeout(() => { indicator.classList.add('hidden'); }, 2000); }
        }

        function changeView(view) {
            currentView = view;
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${view}`).classList.add('active');
            renderCurrentView();
        }

        function renderCurrentView() {
            const m = timeline[activeIndex];
            const container = document.getElementById('main-content');
            container.innerHTML = '';
            if (currentView === 'overview') renderOverviewPage(m, activeIndex);
            else if (currentView === 'transactions') renderTransactionsPage(m, activeIndex);
            else if (currentView === 'wallet') renderWalletPage(m, activeIndex);
            lucide.createIcons();
        }

        function renderOverviewPage(m, idx) {
            const d = m.data;
            const inc = d.incomeEntries.reduce((s, x) => s + (x.isCalculated ? (x.hours * x.rate) : (x.value || 0)), 0);
            const fixP = d.fixedExpensesEntries.reduce((s, x) => s + (x.isPaid ? x.value : 0), 0);
            const fixT = d.fixedExpensesEntries.reduce((s, x) => s + (x.value || 0), 0);
            const varP = d.variableExpensesEntries.reduce((s, x) => s + (x.isPaid ? x.value : 0), 0);
            const varT = d.variableExpensesEntries.reduce((s, x) => s + (x.value || 0), 0);
            const totalT = fixT + varT;
            const bal = inc - totalT;
            const prog = totalT > 0 ? (((fixP + varP) / totalT) * 100).toFixed(0) : 0;

            document.getElementById('main-content').innerHTML = `
                <div class="view-section active space-y-6">
                    <div class="card bg-gradient-to-br from-blue-600 to-indigo-800 border-none">
                        <p class="text-[10px] font-black text-blue-200 uppercase mb-1 opacity-80 tracking-widest text-center">Saldo Previsto Final</p>
                        <h2 class="text-4xl font-black text-white text-center">${formatBRL(bal)}</h2>
                        <div class="mt-8 grid grid-cols-2 border-t border-white/10 pt-4">
                            <div class="text-center border-r border-white/10"><p class="text-[9px] font-black text-blue-200 uppercase opacity-70">Renda Total</p><p class="text-md font-black text-white">${formatBRL(inc)}</p></div>
                            <div class="text-center"><p class="text-[9px] font-black text-blue-200 uppercase opacity-70">Despesas</p><p class="text-md font-black text-white">${formatBRL(totalT)}</p></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-[10px] font-black uppercase text-slate-500 tracking-widest">Contas Pagas</h3>
                            <span class="text-xs font-black text-emerald-400">${prog}%</span>
                        </div>
                        <div class="w-full bg-slate-700/50 h-3 rounded-full overflow-hidden">
                            <div class="bg-emerald-500 h-full transition-all duration-1000" style="width: ${prog}%"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mt-6">
                            <div class="flex items-center gap-3"><div class="p-2.5 bg-blue-500/10 rounded-2xl"><i data-lucide="lock" class="w-4 h-4 text-blue-400"></i></div><div><p class="text-[8px] font-bold text-slate-500 uppercase">Fixas</p><p class="text-xs font-black">${formatBRL(fixT)}</p></div></div>
                            <div class="flex items-center gap-3"><div class="p-2.5 bg-orange-500/10 rounded-2xl"><i data-lucide="shopping-bag" class="w-4 h-4 text-orange-400"></i></div><div><p class="text-[8px] font-bold text-slate-500 uppercase">Variáveis</p><p class="text-xs font-black">${formatBRL(varT)}</p></div></div>
                        </div>
                    </div>
                    <button onclick="showCashFlow(${idx})" class="btn bg-slate-800 w-full py-5 rounded-3xl border border-slate-700 font-black uppercase tracking-widest text-blue-400 active:scale-95 shadow-lg">
                        <i data-lucide="bar-chart-2" class="w-4 h-4"></i> Fluxo Detalhado
                    </button>
                    <div class="card h-52">
                        <h3 class="text-[10px] font-black uppercase text-slate-600 mb-4 text-center tracking-widest">Gráfico Mensal</h3>
                        <canvas id="overviewChart"></canvas>
                    </div>
                </div>
            `;
            setTimeout(initOverviewChart, 100);
        }

        function renderTransactionsPage(m, idx) {
            document.getElementById('main-content').innerHTML = `
                <div class="view-section active space-y-8">
                    <section>
                        <div class="flex justify-between items-center mb-4"><h3 class="text-xs font-black text-emerald-400 uppercase tracking-widest">Entradas</h3><button onclick="addItem(${idx}, 'income')" class="text-[10px] font-black text-slate-400 bg-slate-800/50 px-4 py-1.5 rounded-full uppercase border border-slate-700">+ Adicionar</button></div>
                        <div id="list-income-${idx}" class="space-y-3"></div>
                    </section>
                    <section>
                        <div class="flex justify-between items-center mb-4"><h3 class="text-xs font-black text-blue-400 uppercase tracking-widest">Contas Fixas</h3><button onclick="addItem(${idx}, 'fixed')" class="text-[10px] font-black text-slate-400 bg-slate-800/50 px-4 py-1.5 rounded-full uppercase border border-slate-700">+ Adicionar</button></div>
                        <div id="list-fixed-${idx}" class="space-y-3"></div>
                    </section>
                    <section>
                        <div class="flex justify-between items-center mb-4"><h3 class="text-xs font-black text-orange-400 uppercase tracking-widest">Variáveis</h3><button onclick="addItem(${idx}, 'variable')" class="text-[10px] font-black text-slate-400 bg-slate-800/50 px-4 py-1.5 rounded-full uppercase border border-slate-700">+ Adicionar</button></div>
                        <div id="list-variable-${idx}" class="space-y-3"></div>
                    </section>
                </div>
            `;
            renderMonthLists(idx);
        }

        function renderWalletPage(m, idx) {
            const all = [...m.data.fixedExpensesEntries, ...m.data.variableExpensesEntries];
            const liveB1 = (m.bank1Balance || 0) - all.filter(x => x.isPaid && x.source === 'B1').reduce((s, x) => s + x.value, 0);
            const liveB2 = (m.bank2Balance || 0) - all.filter(x => x.isPaid && x.source === 'B2').reduce((s, x) => s + x.value, 0);

            document.getElementById('main-content').innerHTML = `
                <div class="view-section active space-y-6">
                    <div class="text-center mb-2"><h2 class="text-[10px] font-black text-slate-600 uppercase tracking-tighter">Carteira Viva (Saldo Atual)</h2></div>
                    
                    <!-- Banco 1 -->
                    <div class="card border-blue-500/20 bg-blue-900/5 text-center py-10">
                        <input type="text" value="${m.bank1Name}" onchange="updateBankName(${idx}, 'bank1Name', this.value)" class="bank-name-input mb-3" placeholder="NOME DO BANCO 1">
                        <div class="flex items-center justify-center font-black">
                            <span class="text-2xl text-blue-500 mr-2">R$</span>
                            <input type="number" step="0.01" value="${liveB1.toFixed(2)}" onchange="handleWalletEdit(${idx}, 'bank1Balance', this.value)" class="bank-input-live" style="color: ${liveB1 >= 0 ? '#10b981' : '#ef4444'}">
                        </div>
                    </div>

                    <!-- Banco 2 -->
                    <div class="card border-emerald-500/20 bg-emerald-900/5 text-center py-10">
                        <input type="text" value="${m.bank2Name}" onchange="updateBankName(${idx}, 'bank2Name', this.value)" class="bank-name-input mb-3" placeholder="NOME DO BANCO 2">
                        <div class="flex items-center justify-center font-black">
                            <span class="text-2xl text-emerald-500 mr-2">R$</span>
                            <input type="number" step="0.01" value="${liveB2.toFixed(2)}" onchange="handleWalletEdit(${idx}, 'bank2Balance', this.value)" class="bank-input-live" style="color: ${liveB2 >= 0 ? '#10b981' : '#ef4444'}">
                        </div>
                    </div>

                    <div class="p-4 bg-slate-900/50 rounded-2xl border border-slate-800">
                         <p class="text-[9px] text-slate-600 font-bold leading-relaxed text-center uppercase tracking-widest">Toque nos nomes acima para renomear os seus bancos. Toque nos valores para definir o saldo que você tem hoje.</p>
                    </div>
                </div>
            `;
        }

        // --- CORE ---
        function renderAll() {
            const tabs = document.getElementById('month-tabs-container');
            if (tabs) tabs.innerHTML = timeline.map((m, i) => `<button onclick="selecionarMes(${i})" class="month-tab ${i === activeIndex ? 'active-month-tab' : 'bg-slate-800/40 text-slate-500'}">${m.label}</button>`).join('') + `<button onclick="addNewMonthManual()" class="month-tab bg-slate-800/40 text-slate-400">+</button>`;
            renderCurrentView();
        }

        function selecionarMes(idx) { activeIndex = idx; renderAll(); }

        function updateBankName(idx, field, val) {
            timeline[idx][field] = val.toUpperCase() || (field === 'bank1Name' ? 'BANCO 1' : 'BANCO 2');
            saveData();
            // Nao precisa re-renderizar a pagina toda pra nao perder o foco do input
        }

        function handleWalletEdit(mIdx, field, val) {
            const m = timeline[mIdx];
            const sourceKey = field === 'bank1Balance' ? 'B1' : 'B2';
            const sumPaid = [...m.data.fixedExpensesEntries, ...m.data.variableExpensesEntries].filter(x => x.isPaid && x.source === sourceKey).reduce((s, x) => s + x.value, 0);
            m[field] = (parseFloat(val) || 0) + sumPaid;
            saveData();
            renderCurrentView();
        }

        function renderMonthLists(mIdx) {
            const m = timeline[mIdx];
            renderItemList(mIdx, 'income', m.data.incomeEntries);
            renderItemList(mIdx, 'fixed', m.data.fixedExpensesEntries);
            renderItemList(mIdx, 'variable', m.data.variableExpensesEntries);
        }

        function renderItemList(mIdx, type, items) {
            const container = document.getElementById(`list-${type}-${mIdx}`);
            if (!container) return;
            const b1Name = timeline[mIdx].bank1Name.substring(0,3);
            const b2Name = timeline[mIdx].bank2Name.substring(0,3);

            container.innerHTML = items.map(item => {
                const isPaid = item.isPaid !== undefined ? item.isPaid : true;
                let valHtml = `<input type="number" step="0.01" value="${item.value || 0}" class="bg-transparent border-none p-0 text-[0.9rem] font-black w-20 text-right focus:ring-0" onchange="updateValue(${mIdx},'${type}','${item.id}',this.value)" ${item.isCalculated || item.isSystem ? 'readonly' : ''}>`;
                if (item.isCalculated) {
                    const tot = (item.hours||0)*(item.rate||0);
                    valHtml = `<div class="flex items-center gap-1 font-black text-xs text-slate-500"><input type="number" value="${item.hours || 0}" class="bg-slate-900 rounded w-8 text-center p-0.5" onchange="updateProp(${mIdx},'income','${item.id}','hours',this.value)"><span>h = ${tot.toFixed(0)}</span></div>`;
                }
                const isExp = type === 'fixed' || type === 'variable';
                const bankLabel = item.source === 'B1' ? b1Name : b2Name;

                return `
                <div class="p-4 item-row ${isPaid ? 'item-paid' : 'item-unpaid'}">
                    <div class="flex items-center justify-between gap-3 mb-4">
                        <div class="flex flex-col flex-grow min-w-0">
                             <input type="text" value="${item.name}" class="main-text bg-transparent border-none text-[0.85rem] font-black w-full focus:ring-0 truncate p-0 mb-1" onchange="updateProp(${mIdx},'${type}','${item.id}','name',this.value)" ${item.isSystem?'readonly':''}>
                             <div class="flex items-center gap-2">
                                <input type="date" value="${item.date||''}" class="bg-transparent border-none p-0 text-[10px] text-slate-500 font-bold" onchange="updateProp(${mIdx},'${type}','${item.id}','date',this.value)">
                                ${isExp ? `<span class="bank-tag ${item.source==='B1'?'text-blue-400 border-blue-400/30':'text-emerald-400 border-emerald-400/30'}" onclick="toggleSource(${mIdx},'${type}','${item.id}')">${bankLabel}</span>` : ''}
                             </div>
                        </div>
                        <div class="flex items-center gap-1"><span class="text-[10px] font-black text-slate-600">R$</span>${valHtml}</div>
                    </div>
                    
                    <!-- Linha Inferior com Lixeira e Switch -->
                    <div class="flex justify-between items-center pt-2 border-t border-white/5">
                        ${!item.isSystem ? `<div onclick="removeItem(${mIdx},'${type}','${item.id}')" class="p-2 bg-slate-800/50 rounded-lg text-slate-600 active:bg-red-900/20 active:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></div>` : '<div></div>'}
                        ${item.isPaid!==undefined && !item.isSystem ? `<label class="toggle-switch"><input type="checkbox" ${isPaid?'checked':''} onchange="togglePaid(${mIdx},'${type}','${item.id}')"><span class="slider"></span></label>`: ''}
                    </div>
                </div>`}).join('');
            lucide.createIcons();
        }

        // --- HANDLERS ---
        function updateProp(mIdx,type,id,p,v) { const i = getL(mIdx,type).find(x=>x.id==id); if(i){ i[p]=(p==='hours'?parseFloat(v):v); saveData(); propagateBalances(); renderCurrentView(); } }
        function updateValue(mIdx,type,id,v) { const i = getL(mIdx,type).find(x=>x.id==id); if(i){ i.value=parseFloat(v)||0; saveData(); propagateBalances(); renderCurrentView(); } }
        function togglePaid(mIdx,type,id) { const i = getL(mIdx,type).find(x=>x.id==id); if(i){ i.isPaid=!i.isPaid; saveData(); renderCurrentView(); } }
        function toggleSource(mIdx,type,id) { const i = getL(mIdx,type).find(x=>x.id==id); if(i){ i.source = i.source === 'B1' ? 'B2' : 'B1'; saveData(); renderCurrentView(); } }
        function addItem(mIdx,type) { getL(mIdx,type).push({ id: Math.random(), name: 'Novo Item', value: 0, date: new Date().toISOString().slice(0,10), isPaid: false, source: 'B1' }); saveData(); propagateBalances(); renderCurrentView(); }
        function removeItem(mIdx,type,id) { customConfirm("Remover lançamento?", "Isso apagará o item deste mês definitivamente.", () => { const k = type==='income'?'incomeEntries':(type==='fixed'?'fixedExpensesEntries':'variableExpensesEntries'); timeline[mIdx].data[k] = getL(mIdx,type).filter(x=>x.id!=id); saveData(); propagateBalances(); renderCurrentView(); }); }
        function getL(mIdx,type) { const d = timeline[mIdx].data; return type==='income'?d.incomeEntries:(type==='fixed'?d.fixedExpensesEntries:d.variableExpensesEntries); }
        
        function propagateBalances() {
            for (let i = 0; i < timeline.length - 1; i++) {
                const d = timeline[i].data;
                const inc = d.incomeEntries.reduce((s, x) => s + (x.isCalculated ? (x.hours * x.rate) : (x.value || 0)), 0);
                const fixT = d.fixedExpensesEntries.reduce((s, x) => s + (x.value || 0), 0);
                const varT = d.variableExpensesEntries.reduce((s, x) => s + (x.value || 0), 0);
                let nextSys = timeline[i+1].data.incomeEntries.find(x => x.isSystem);
                if(nextSys) nextSys.value = inc - (fixT + varT);
            }
        }

        function applyGlobalItem() {
            const n = document.getElementById('global-name').value;
            const v = parseFloat(document.getElementById('global-value').value) || 0;
            const t = document.getElementById('global-type').value;
            const d = document.getElementById('global-date').value;
            if(!n || !d) return;
            const day = new Date(d + 'T00:00:00').getDate();
            timeline.forEach(m => {
                const list = t==='income'?m.data.incomeEntries:(t==='fixed'?m.data.fixedExpensesEntries:m.data.variableExpensesEntries);
                let targetDate = new Date(m.year, MONTH_NAMES.indexOf(m.label), day);
                if (targetDate.getMonth() !== MONTH_NAMES.indexOf(m.label)) targetDate.setDate(0); 
                list.push({ id: Math.random(), name: n, value: v, date: targetDate.toISOString().slice(0, 10), isPaid: false, source: 'B1' });
            });
            saveData(); propagateBalances(); renderCurrentView(); closeModal('global-tool-modal');
        }

        function advanceTimeline() { 
            customConfirm("Encerrar o mês?", "O mês mais antigo será excluído para dar espaço ao novo.", () => { 
                timeline.shift(); 
                if(timeline.length < 1) createInitialTimeline(); 
                else { 
                    const last = timeline[timeline.length - 1]; 
                    let nIdx = (MONTH_NAMES.indexOf(last.label) + 1) % 12; 
                    let nYear = nIdx === 0 ? last.year + 1 : last.year; 
                    timeline.push({ label: MONTH_NAMES[nIdx], year: nYear, bank1Name: last.bank1Name, bank2Name: last.bank2Name, bank1Balance: 0, bank2Balance: 0, data: createEmptyMonthData(nIdx, nYear) }); 
                } 
                saveData(); location.reload(); 
            }); 
        }
        
        function initOverviewChart() {
            const ctx = document.getElementById('overviewChart');
            if(!ctx) return;
            const labels = timeline.map(m => m.label);
            const incs = timeline.map(m => m.data.incomeEntries.reduce((s, x) => s + (x.isCalculated ? (x.hours * x.rate) : (x.value || 0)), 0));
            const exps = timeline.map(m => m.data.fixedExpensesEntries.reduce((s, x) => s + (x.value || 0), 0) + m.data.variableExpensesEntries.reduce((s, x) => s + (x.value || 0), 0));
            if(globalChart) globalChart.destroy();
            globalChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: { labels, datasets: [
                    { data: incs, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.4, borderWidth: 4, pointRadius: 0 },
                    { data: exps, borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', fill: true, tension: 0.4, borderWidth: 4, pointRadius: 0 }
                ]},
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false }, ticks: { color: '#64748b', font: { size: 9, weight: 'bold' } } } } }
            });
        }

        function showCashFlow(idx) {
            const m = timeline[idx]; const entries = [...m.data.incomeEntries.map(i => ({ ...i, val: i.isCalculated?i.hours*i.rate:i.value, type:'IN' })), ...m.data.fixedExpensesEntries.map(i => ({ ...i, val: -i.value, type:'OUT' })), ...m.data.variableExpensesEntries.map(i => ({ ...i, val: -i.value, type:'OUT' }))].sort((a,b) => { const dA = new Date(a.date || '9999-12-31'); const dB = new Date(b.date || '9999-12-31'); if (dA - dB !== 0) return dA - dB; return a.type === 'IN' ? -1 : 1; });
            let run = 0; document.getElementById('cashflow-content').innerHTML = `<table class="w-full text-left"><thead class="sticky top-0 bg-slate-800 text-[10px] uppercase text-slate-500"><tr><th class="p-3">Data</th><th>Descr.</th><th class="text-right">Valor</th></tr></thead><tbody>${entries.map(e=>{ run+=e.val; return `<tr class="border-b border-slate-700/50 text-[11px]"><td class="p-3 text-slate-500 font-mono">${e.date?new Date(e.date+'T00:00:00').toLocaleDateString('pt-BR'):'-'}</td><td class="font-bold text-slate-300">${e.name}</td><td class="text-right font-bold ${e.type==='IN'?'text-green-400':'text-red-400'}">${formatBRL(e.val)}</td></tr>`}).join('')}</tbody></table>`;
            document.getElementById('cashflow-title').innerText = `Fluxo: ${m.label}`; openModal('cashflow-modal-overlay');
        }

        function openModal(id) { document.getElementById(id).style.display='flex'; lucide.createIcons(); }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        function formatBRL(v) { return v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
        function customConfirm(t, b, cb) { document.getElementById('confirm-title').innerText = t; document.getElementById('confirm-body').innerText = b; const btn = document.getElementById('confirm-btn-yes'); btn.onclick = () => { closeModal('confirm-modal-overlay'); cb(); }; openModal('confirm-modal-overlay'); }
        function editAppTitle() { const n = prompt("Novo nome da planilha:", "Finanças Pro"); if(n){ document.getElementById('app-display-title').innerText = n; localStorage.setItem(TITLE_KEY, n); saveData(); } }
        function downloadBackup() { const b = new Blob([JSON.stringify(timeline)], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `backup_financas.json`; a.click(); }
        function handleImport(input) { const r = new FileReader(); r.onload = e => { timeline = JSON.parse(e.target.result); migrateToV39(); location.reload(); }; r.readAsText(input.files[0]); }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
