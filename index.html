<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#020617"/>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">

    <title id="page-title">Finanças Pro v42</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #f1f5f9; scroll-behavior: smooth; -webkit-tap-highlight-color: transparent; }
        
        .card { background-color: #1e293b; border-radius: 1rem; box-shadow: 0 4px 15px -3px rgba(0, 0, 0, 0.3); padding: 1rem; border: 1px solid #334155; }
        
        /* ITENS ULTRA COMPACTOS */
        .item-row { transition: all 0.2s ease; border-width: 1px; border-style: solid; border-radius: 0.75rem; background-color: #1e293b; margin-bottom: 0.4rem; padding: 0.5rem 0.75rem; }
        .item-paid { background-color: rgba(16, 185, 129, 0.04); border-color: rgba(16, 185, 129, 0.3) !important; }
        .item-paid .main-text, .item-paid input { color: #10b981 !important; }
        .item-unpaid { background-color: rgba(239, 68, 68, 0.03); border-color: rgba(239, 68, 68, 0.2) !important; }
        .item-unpaid .main-text, .item-unpaid input { color: #ef4444 !important; }

        /* Campos de input mais discretos */
        .input-clean { background: transparent; border: none; padding: 0; outline: none; width: 100%; font-size: 0.85rem; font-weight: 700; }
        .input-date-clean { background: transparent; border: none; padding: 0; color: #64748b; font-size: 0.65rem; width: auto; outline: none; }
        
        .btn-sm-action { padding: 0.4rem; border-radius: 0.5rem; transition: all 0.2s; color: #475569; }
        .btn-sm-action:hover { color: #ef4444; background: rgba(239, 68, 68, 0.1); }

        .month-tab { padding: 0.5rem 1rem; border-radius: 2rem; transition: all 0.3s; opacity: 0.5; font-weight: 800; font-size: 0.75rem; white-space: nowrap; background: #1e293b; border: 1px solid #334155; }
        .active-month-tab { opacity: 1 !important; background: #3b82f6 !important; border-color: #60a5fa !important; color: white; }
        
        .toggle-switch-mini { position: relative; display: inline-flex; width: 34px; height: 18px; flex-shrink: 0; }
        .toggle-switch-mini input { opacity: 0; width: 0; height: 0; }
        .slider-mini { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #475569; transition: .4s; border-radius: 34px; }
        .slider-mini:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider-mini { background-color: #10b981; }
        input:checked + .slider-mini:before { transform: translateX(16px); }

        .planilha-mes-container { display: none; }
        .active-month-container { display: block !important; }

        .bank-input-live { background: transparent; border: none; font-size: 1.1rem; font-weight: 900; color: #10b981; text-align: center; width: 100%; outline: none; }
        .bank-name-input { background: transparent; border: none; font-size: 0.6rem; font-weight: 900; color: #64748b; text-align: center; width: 100%; outline: none; text-transform: uppercase; }
        .bank-tag { font-size: 0.55rem; padding: 1px 5px; border-radius: 4px; font-weight: 900; background: #0f172a; border: 1px solid #334155; cursor: pointer; color: #94a3b8; }

        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.85); z-index: 100; display: none; align-items: center; justify-content: center; padding: 1rem; backdrop-filter: blur(8px); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        #save-indicator { position: fixed; top: 1rem; right: 1rem; padding: 0.4rem 0.8rem; border-radius: 2rem; background: #10b981; color: white; font-size: 0.6rem; font-weight: bold; display: none; z-index: 200; animation: fadeOut 2s forwards; }
        @keyframes fadeOut { 0% { opacity: 1; } 80% { opacity: 1; } 100% { opacity: 0; } }
    </style>
</head>
<body class="p-3 md:p-6 pb-20">

    <div id="save-indicator">Sincronizado</div>

    <div class="max-w-7xl mx-auto">
        <!-- Header Compacto -->
        <header class="mb-4 flex justify-between items-center gap-2">
            <div class="flex items-center gap-2 cursor-pointer" onclick="editAppTitle()">
                <h1 id="app-display-title" class="text-lg font-black text-white uppercase tracking-tighter">Finanças Pro</h1>
                <i data-lucide="pencil" class="w-3 h-3 text-blue-400"></i>
            </div>
            <div class="flex items-center gap-1">
                <button onclick="openModal('global-tool-modal')" class="p-2 bg-slate-800 rounded-lg text-yellow-500" title="Recorrentes"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button>
                <button onclick="openModal('backup-modal-overlay')" class="p-2 bg-slate-800 rounded-lg text-slate-400" title="Menu"><i data-lucide="more-vertical" class="w-4 h-4"></i></button>
            </div>
        </header>

        <!-- Navegação de Meses Compacta -->
        <div class="flex overflow-x-auto no-scrollbar gap-1.5 mb-6" id="month-tabs-container"></div>

        <!-- Renderizador -->
        <div id="planilhas-container"></div>
    </div>

    <!-- FAB Gráfico Pequeno -->
    <div class="fixed bottom-6 right-6 w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center shadow-lg z-40 active:scale-90 transition-transform" onclick="openChartModal()">
        <i data-lucide="bar-chart-3" class="text-white w-5 h-5"></i>
    </div>

    <!-- Modais -->
    <div id="global-tool-modal" class="modal-overlay">
        <div class="card w-full max-w-sm">
            <div class="flex justify-between items-center mb-4"><h2 class="text-sm font-black uppercase">Lançar Recorrente</h2><button onclick="closeModal('global-tool-modal')"><i data-lucide="x"></i></button></div>
            <div class="space-y-3">
                <div class="grid grid-cols-2 gap-2"><input type="text" id="global-name" placeholder="Nome" class="input-field"><input type="number" id="global-value" placeholder="Valor" class="input-field"></div>
                <div class="grid grid-cols-2 gap-2">
                    <select id="global-type" class="input-field"><option value="fixed">Dívida Fixa</option><option value="variable">Dívida Variável</option><option value="income">Entrada</option></select>
                    <input type="date" id="global-date" class="input-field">
                </div>
                <button onclick="applyGlobalItem()" class="btn btn-primary w-full py-3 font-black uppercase text-xs">Aplicar em Tudo</button>
            </div>
        </div>
    </div>

    <div id="chart-modal-overlay" class="modal-overlay"><div class="card w-full max-w-4xl"><div class="flex justify-between items-center mb-4"><h2>Evolução</h2><button onclick="closeModal('chart-modal-overlay')"><i data-lucide="x"></i></button></div><div class="h-[40vh]"><canvas id="globalChart"></canvas></div></div></div>
    <div id="cashflow-modal-overlay" class="modal-overlay"><div class="card w-full max-w-2xl max-h-[80vh] flex flex-col overflow-hidden"><div class="flex justify-between items-center mb-4"><h2>Fluxo</h2><button onclick="closeModal('cashflow-modal-overlay')"><i data-lucide="x"></i></button></div><div class="overflow-y-auto no-scrollbar" id="cashflow-content"></div></div></div>
    <div id="backup-modal-overlay" class="modal-overlay"><div class="card w-full max-w-xs text-center"><div class="flex justify-between items-center mb-6"><h2>Menu</h2><button onclick="closeModal('backup-modal-overlay')"><i data-lucide="x"></i></button></div><div class="space-y-3"><button onclick="advanceTimeline()" class="btn btn-secondary w-full text-red-400">Encerrar Mês</button><button onclick="downloadBackup()" class="btn btn-primary w-full">Exportar Dados</button><input type="file" id="importFile" class="hidden" accept=".json" onchange="handleImport(this)"><button onclick="document.getElementById('importFile').click()" class="btn btn-secondary w-full">Importar Dados</button></div></div></div>
    <div id="confirm-modal-overlay" class="modal-overlay"><div class="card w-full max-w-xs text-center"><h3>Confirmar?</h3><p id="confirm-body" class="text-xs text-slate-400 mb-6"></p><div class="flex justify-center gap-4"><button id="confirm-btn-yes" class="btn btn-primary px-8">Sim</button><button onclick="closeModal('confirm-modal-overlay')" class="btn btn-secondary">Não</button></div></div></div>

    <script>
        const STORAGE_KEY = 'financialData_App_v42_final';
        const TITLE_KEY = 'financialApp_Title_v35';
        const MONTH_NAMES = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        
        let timeline = [];
        let activeIndex = 0;
        let globalChart = null;

        function initApp() {
            const savedTitle = localStorage.getItem(TITLE_KEY);
            if (savedTitle) { document.getElementById('app-display-title').innerText = savedTitle; }
            
            let saved = localStorage.getItem(STORAGE_KEY);
            if (!saved) saved = localStorage.getItem('financialData_App_v41_final');
            if (!saved) saved = localStorage.getItem('financialData_Classic_v40_wallet');
            
            if (saved) {
                timeline = JSON.parse(saved);
                migrateToV42();
            } else {
                createInitialTimeline();
            }
            renderAll();
            selecionarMes(0);
        }

        function createInitialTimeline() {
            let now = new Date();
            let startMonth = now.getMonth();
            let startYear = now.getFullYear();
            timeline = [];
            for (let i = 0; i < 6; i++) {
                let mIdx = (startMonth + i) % 12;
                let yOff = Math.floor((startMonth + i) / 12);
                timeline.push({ label: MONTH_NAMES[mIdx], year: startYear + yOff, bank1Name: 'BANCO DO BRASIL', bank2Name: 'MERCADO PAGO', bank1Balance: 0, bank2Balance: 0, data: createEmptyMonthData(mIdx, startYear + yOff) });
            }
            saveData();
        }

        function createEmptyMonthData(mIdx, year) {
            const firstDay = new Date(year, mIdx, 1).toISOString().slice(0, 10);
            return { incomeEntries: [{ id: 'saldo-sys', name: 'Saldo Anterior', value: 0, isSystem: true, date: firstDay }], fixedExpensesEntries: [], variableExpensesEntries: [] };
        }

        function migrateToV42() {
            timeline.forEach(m => {
                if (!m.bank1Name) m.bank1Name = 'BANCO DO BRASIL';
                if (!m.bank2Name) m.bank2Name = 'MERCADO PAGO';
                if (m.data) {
                    if (!m.data.incomeEntries) m.data.incomeEntries = [];
                    if (!m.data.fixedExpensesEntries) m.data.fixedExpensesEntries = m.data.fixedExpenses || [];
                    if (!m.data.variableExpensesEntries) m.data.variableExpensesEntries = m.data.variableExpenses || [];
                    [...m.data.fixedExpensesEntries, ...m.data.variableExpensesEntries].forEach(item => { if (item.source === undefined) item.source = 'B1'; });
                }
            });
            saveData();
        }

        function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(timeline)); const ind = document.getElementById('save-indicator'); if (ind) { ind.style.display = 'block'; setTimeout(() => { ind.style.display = 'none'; }, 2000); } }

        function renderAll() { renderTabs(); renderMonths(); lucide.createIcons(); }

        function renderTabs() {
            const container = document.getElementById('month-tabs-container');
            if (!container) return;
            container.innerHTML = timeline.map((m, i) => {
                const unpaid = [...(m.data.fixedExpensesEntries||[]), ...(m.data.variableExpensesEntries||[])].filter(e => !e.isPaid).length;
                return `<button onclick="selecionarMes(${i})" id="tab-${i}" class="month-tab ${i === activeIndex ? 'active-month-tab' : ''}">${m.label} ${unpaid > 0 ? `<span class="ml-1 text-[8px] bg-red-500 text-white px-1.5 py-0.5 rounded-full">${unpaid}</span>` : ''}</button>`
            }).join('') + `<button onclick="addNewMonthManual()" class="month-tab">+</button>`;
        }

        function renderMonths() {
            const container = document.getElementById('planilhas-container');
            if (!container) return; container.innerHTML = '';
            timeline.forEach((m, i) => {
                const div = document.createElement('div');
                div.id = `container-${i}`;
                div.className = `planilha-mes-container space-y-4 ${i === activeIndex ? 'active-month-container' : ''}`;
                div.innerHTML = `
                    <!-- COCKPIT ULTRA COMPACTO -->
                    <div class="card bg-slate-800/60 border-blue-500/20 py-3">
                        <div class="flex flex-col space-y-3">
                            <div class="flex justify-between items-center px-1">
                                <h4 class="text-[10px] font-black text-slate-500 uppercase">${m.label} ${m.year}</h4>
                                <button onclick="showCashFlow(${i})" class="text-[9px] text-blue-400 font-bold uppercase tracking-tighter">Analisar Fluxo</button>
                            </div>
                            <div class="w-full bg-slate-700 h-1 rounded-full overflow-hidden mx-1">
                                <div id="prog-paid-${i}" class="bg-green-500 h-full transition-all duration-700" style="width: 0%"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div class="bg-slate-900/40 p-2 rounded-xl border border-slate-700/50 text-center">
                                    <p class="text-[8px] text-slate-500 uppercase mb-0.5">Renda</p>
                                    <p class="text-xs font-black text-green-400" id="stat-inc-${i}">R$ 0</p>
                                </div>
                                <div class="bg-slate-900/40 p-2 rounded-xl border border-slate-700/50 text-center">
                                    <p class="text-[8px] text-slate-500 uppercase mb-0.5">Saldo Final</p>
                                    <p class="text-xs font-black text-blue-400" id="stat-bal-${i}">R$ 0</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-4 gap-1 text-center pt-1 border-t border-slate-700/20">
                                <div><p class="text-[7px] text-slate-500">FIXAS</p><p class="text-[9px] font-bold text-blue-300" id="det-fix-${i}">R$ 0</p></div>
                                <div><p class="text-[7px] text-slate-500">VARIAV</p><p class="text-[9px] font-bold text-orange-300" id="det-var-${i}">R$ 0</p></div>
                                <div><p class="text-[7px] text-red-500">PEND</p><p class="text-[9px] font-bold text-red-500" id="det-pend-${i}">R$ 0</p></div>
                                <div><p class="text-[7px] text-slate-500">TOTAL</p><p class="text-[9px] font-bold text-white" id="det-tot-${i}">R$ 0</p></div>
                            </div>
                            <div class="pt-2 border-t border-slate-700/30">
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="bg-blue-900/10 p-2 rounded-xl border border-blue-500/20 text-center">
                                        <input type="text" value="${m.bank1Name}" onchange="updateBankName(${i}, 'bank1Name', this.value)" class="bank-name-input">
                                        <div class="flex items-center justify-center font-black"><span class="text-[10px] text-green-500 mr-1">R$</span><input type="number" step="0.01" id="live-b1-${i}" onchange="handleWalletEdit(${i}, 'bank1Balance', this.value)" class="bank-input-live"></div>
                                    </div>
                                    <div class="bg-green-900/10 p-2 rounded-xl border border-green-500/20 text-center">
                                        <input type="text" value="${m.bank2Name}" onchange="updateBankName(${i}, 'bank2Name', this.value)" class="bank-name-input">
                                        <div class="flex items-center justify-center font-black"><span class="text-[10px] text-green-500 mr-1">R$</span><input type="number" step="0.01" id="live-b2-${i}" onchange="handleWalletEdit(${i}, 'bank2Balance', this.value)" class="bank-input-live"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 pb-10">
                        <div class="card border-l-4 border-green-500 h-fit p-3">
                            <div class="flex justify-between items-center mb-3"><h3 class="text-xs font-black text-green-400 uppercase">Entradas</h3><i data-lucide="copy" class="w-3 h-3 text-slate-600 cursor-pointer" onclick="copyPrev(${i},'income')"></i></div>
                            <div id="list-income-${i}" class="space-y-1"></div>
                            <button onclick="addItem(${i}, 'income')" class="w-full py-2 mt-3 bg-slate-800 rounded-lg text-[9px] font-black uppercase tracking-widest">+ Adicionar</button>
                        </div>
                        <div class="card border-l-4 border-blue-500 h-fit p-3">
                            <div class="flex justify-between items-center mb-3"><h4 class="text-xs font-black text-blue-400 uppercase">Fixas</h4><i data-lucide="copy" class="w-3 h-3 text-slate-600 cursor-pointer" onclick="copyPrev(${i},'fixed')"></i></div>
                            <div id="list-fixed-${i}" class="space-y-1"></div>
                            <button onclick="addItem(${i}, 'fixed')" class="w-full py-2 mt-3 bg-slate-800 rounded-lg text-[9px] font-black uppercase tracking-widest">+ Adicionar</button>
                        </div>
                        <div class="card border-l-4 border-orange-500 h-fit p-3">
                            <div class="flex justify-between items-center mb-3"><h4 class="text-xs font-black text-orange-400 uppercase">Variáveis</h4><i data-lucide="copy" class="w-3 h-3 text-slate-600 cursor-pointer" onclick="copyPrev(${i},'variable')"></i></div>
                            <div id="list-variable-${i}" class="space-y-1"></div>
                            <button onclick="addItem(${i}, 'variable')" class="w-full py-2 mt-3 bg-slate-800 rounded-lg text-[9px] font-black uppercase tracking-widest">+ Adicionar</button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
            timeline.forEach((_, idx) => renderMonthLists(idx));
        }

        function renderMonthLists(mIdx) {
            renderItemList(mIdx, 'income', timeline[mIdx].data.incomeEntries);
            renderItemList(mIdx, 'fixed', timeline[mIdx].data.fixedExpensesEntries);
            renderItemList(mIdx, 'variable', timeline[mIdx].data.variableExpensesEntries);
        }

        function renderItemList(mIdx, type, items) {
            const container = document.getElementById(`list-${type}-${mIdx}`);
            if (!container) return;
            const b1S = (timeline[mIdx].bank1Name || "B1").substring(0,3);
            const b2S = (timeline[mIdx].bank2Name || "B2").substring(0,3);

            container.innerHTML = items.map(item => {
                const isPaid = item.isPaid !== undefined ? item.isPaid : true;
                const isExp = type === 'fixed' || type === 'variable';
                const bankLabel = item.source === 'B1' ? b1S : b2S;

                let valHtml = `<input type="number" step="0.01" value="${item.value || 0}" class="input-clean text-right w-16" onchange="updateValue(${mIdx},'${type}','${item.id}',this.value)" ${item.isCalculated || item.isSystem ? 'readonly' : ''}>`;
                if (item.isCalculated) {
                    const tot = (item.hours||0)*(item.rate||0);
                    valHtml = `<div class="flex items-center gap-1"><input type="number" value="${item.hours || 0}" class="bg-slate-900 rounded w-7 text-center text-[10px] font-bold" onchange="updateProp(${mIdx},'income','${item.id}','hours',this.value)"><span class="text-[9px] font-black text-slate-500">h=${tot.toFixed(0)}</span></div>`;
                }

                return `
                <div class="item-row ${isPaid ? 'item-paid' : 'item-unpaid'}">
                    <div class="flex items-center justify-between gap-2">
                        <div class="flex flex-col flex-grow min-w-0">
                            <div class="flex items-center gap-1.5 truncate">
                                ${isExp ? `<span class="bank-tag" onclick="toggleSource(${mIdx},'${type}','${item.id}')">${bankLabel}</span>` : ''}
                                <input type="text" value="${item.name}" class="main-text input-clean truncate" onchange="updateProp(${mIdx},'${type}','${item.id}','name',this.value)" ${item.isSystem?'readonly':''}>
                            </div>
                            <div class="flex items-center gap-3">
                                <input type="date" value="${item.date||''}" class="input-date-clean" onchange="updateProp(${mIdx},'${type}','${item.id}','date',this.value)">
                                ${!item.isSystem ? `<i data-lucide="trash-2" class="w-3 h-3 text-slate-700 hover:text-red-500 cursor-pointer" onclick="removeItem(${mIdx},'${type}','${item.id}')"></i>` : ''}
                            </div>
                        </div>
                        <div class="flex items-center gap-2 shrink-0">
                            <div class="flex items-center">${valHtml}</div>
                            ${item.isPaid!==undefined && !item.isSystem ? `<label class="toggle-switch-mini"><input type="checkbox" ${isPaid?'checked':''} onchange="togglePaid(${mIdx},'${type}','${item.id}')"><span class="slider-mini"></span></label>`: ''}
                        </div>
                    </div>
                </div>`}).join('');
            lucide.createIcons();
        }

        // --- LÓGICA DE DADOS ---
        function selecionarMes(idx) { activeIndex = idx; refreshUI(); }
        function handleWalletEdit(mIdx, f, v) { const m = timeline[mIdx]; const nV = parseFloat(v) || 0; const sK = f === 'bank1Balance' ? 'B1' : 'B2'; const sP = [...(m.data.fixedExpensesEntries||[]), ...(m.data.variableExpensesEntries||[])].filter(x => x.isPaid && x.source === sK).reduce((s, x) => s + (x.value || 0), 0); m[f] = nV + sP; saveData(); updateStats(mIdx); }
        function updateBankName(idx, f, v) { timeline[idx][f] = v.toUpperCase() || 'BANCO'; saveData(); renderAll(); }
        function updateProp(mIdx,t,id,p,v) { const i = getL(mIdx,t).find(x=>x.id==id); if(i){ i[p]=(p==='hours'?parseFloat(v):v); saveData(); propagateBalances(); refreshUI(); } }
        function updateValue(mIdx,t,id,v) { const i = getL(mIdx,t).find(x=>x.id==id); if(i){ i.value=parseFloat(v)||0; saveData(); propagateBalances(); refreshUI(); } }
        function togglePaid(mIdx,t,id) { const i = getL(mIdx,t).find(x=>x.id==id); if(i){ i.isPaid=!i.isPaid; saveData(); refreshUI(); } }
        function toggleSource(mIdx,t,id) { const i = getL(mIdx,t).find(x=>x.id==id); if(i){ i.source = i.source === 'B1' ? 'B2' : 'B1'; saveData(); refreshUI(); } }
        function addItem(mIdx,t) { getL(mIdx,t).push({ id: Math.random(), name: 'Novo Item', value: 0, date: new Date().toISOString().slice(0,10), isPaid: false, source: 'B1' }); saveData(); propagateBalances(); refreshUI(); }
        function removeItem(mIdx,t,id) { customConfirm("Apagar?", "Deseja remover este item?", () => { const k = t==='income'?'incomeEntries':(t==='fixed'?'fixedExpensesEntries':'variableExpensesEntries'); timeline[mIdx].data[k] = getL(mIdx,t).filter(x=>x.id!=id); saveData(); propagateBalances(); refreshUI(); }); }
        function getL(mIdx,t) { const d = timeline[mIdx].data; return t==='income'?d.incomeEntries:(t==='fixed'?d.fixedExpensesEntries:d.variableExpensesEntries); }

        function propagateBalances() {
            for (let i = 0; i < timeline.length - 1; i++) {
                const d = timeline[i].data;
                const inc = (d.incomeEntries||[]).reduce((s, x) => s + (x.isCalculated ? (x.hours * x.rate) : (x.value || 0)), 0);
                const fixT = (d.fixedExpensesEntries||[]).reduce((s, x) => s + (x.value || 0), 0);
                const varT = (d.variableExpensesEntries||[]).reduce((s, x) => s + (x.value || 0), 0);
                let nextSys = timeline[i+1].data.incomeEntries.find(x => x.isSystem);
                if(nextSys) nextSys.value = inc - (fixT + varT);
            }
        }

        function updateStats(mIdx) {
            const m = timeline[mIdx]; if (!m) return; const d = m.data;
            const inc = (d.incomeEntries||[]).reduce((s, x) => s + (x.isCalculated ? (x.hours * x.rate) : (x.value || 0)), 0);
            const fixP = (d.fixedExpensesEntries||[]).reduce((s, x) => s + (x.isPaid ? (x.value || 0) : 0), 0);
            const fixT = (d.fixedExpensesEntries||[]).reduce((s, x) => s + (x.value || 0), 0);
            const varP = (d.variableExpensesEntries||[]).reduce((s, x) => s + (x.isPaid ? (x.value || 0) : 0), 0);
            const varT = (d.variableExpensesEntries||[]).reduce((s, x) => s + (x.value || 0), 0);
            const totalT = fixT + varT; const totalP = fixP + varP;
            
            const elSet = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = val; };
            elSet(`stat-inc-${mIdx}`, formatBRL(inc)); elSet(`det-fix-${mIdx}`, formatBRL(fixT)); elSet(`det-var-${mIdx}`, formatBRL(varT)); elSet(`det-pend-${mIdx}`, formatBRL(totalT - totalP)); elSet(`det-tot-${mIdx}`, formatBRL(totalT));
            const elBal = document.getElementById(`stat-bal-${mIdx}`); if(elBal) { const bal = inc - totalT; elBal.textContent = formatBRL(bal); elBal.className = `text-xs font-black ${bal>=0?'text-blue-400':'text-red-400'}`; }
            const pr = totalT > 0 ? (totalP / totalT * 100).toFixed(0) : 0; const elB = document.getElementById(`prog-paid-${mIdx}`); if(elB) elB.style.width = pr + '%';

            const sumPaidB1 = [...(d.fixedExpensesEntries||[]), ...(d.variableExpensesEntries||[])].filter(x => x.isPaid && x.source === 'B1').reduce((s, x) => s + (x.value || 0), 0);
            const sumPaidB2 = [...(d.fixedExpensesEntries||[]), ...(d.variableExpensesEntries||[])].filter(x => x.isPaid && x.source === 'B2').reduce((s, x) => s + (x.value || 0), 0);
            const b1 = (m.bank1Balance || 0) - sumPaidB1; const b2 = (m.bank2Balance || 0) - sumPaidB2;
            const in1 = document.getElementById(`live-b1-${mIdx}`); const in2 = document.getElementById(`live-b2-${mIdx}`);
            if(in1) { in1.value = b1.toFixed(2); in1.style.color = b1 >= 0 ? '#10b981' : '#ef4444'; }
            if(in2) { in2.value = b2.toFixed(2); in2.style.color = b2 >= 0 ? '#10b981' : '#ef4444'; }
        }

        function applyGlobalItem() {
            const n = document.getElementById('global-name').value; const v = parseFloat(document.getElementById('global-value').value) || 0; const t = document.getElementById('global-type').value; const d = document.getElementById('global-date').value; if(!n || !d) return; const day = new Date(d + 'T00:00:00').getDate();
            timeline.forEach(m => { const list = t==='income'?m.data.incomeEntries:(t==='fixed'?m.data.fixedExpensesEntries:m.data.variableExpensesEntries); let targetDate = new Date(m.year, MONTH_NAMES.indexOf(m.label), day); if (targetDate.getMonth() !== MONTH_NAMES.indexOf(m.label)) targetDate.setDate(0); list.push({ id: Math.random(), name: n, value: v, date: targetDate.toISOString().slice(0, 10), isPaid: false, source: 'B1' }); });
            saveData(); propagateBalances(); refreshUI(); closeModal('global-tool-modal');
        }

        function refreshUI() { 
            document.querySelectorAll('.planilha-mes-container').forEach(c => c.classList.remove('active-month-container'));
            const activeC = document.getElementById(`container-${activeIndex}`);
            if(activeC) activeC.classList.add('active-month-container');
            timeline.forEach((_, idx) => { renderMonthLists(idx); updateStats(idx); }); renderTabs(); 
        }

        function openModal(id) { document.getElementById(id).style.display='flex'; lucide.createIcons(); }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        function formatBRL(v) { return v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
        function customConfirm(t, b, cb) { document.getElementById('confirm-body').innerText = b; const btn = document.getElementById('confirm-btn-yes'); btn.onclick = () => { closeModal('confirm-modal-overlay'); cb(); }; openModal('confirm-modal-overlay'); }
        function editAppTitle() { const n = prompt("Nome:", "Finanças Pro"); if(n){ document.getElementById('app-display-title').innerText = n; localStorage.setItem(TITLE_KEY, n); saveData(); } }
        function downloadBackup() { const b = new Blob([JSON.stringify(timeline)], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `backup_v42.json`; a.click(); }
        function handleImport(input) { const r = new FileReader(); r.onload = e => { timeline = JSON.parse(e.target.result); migrateToV42(); location.reload(); }; r.readAsText(input.files[0]); }
        function showCashFlow(idx) {
            const m = timeline[idx]; const entries = [...m.data.incomeEntries.map(i => ({ ...i, val: i.isCalculated?i.hours*i.rate:i.value, type:'IN' })), ...(m.data.fixedExpensesEntries||[]).map(i => ({ ...i, val: -i.value, type:'OUT' })), ...(m.data.variableExpensesEntries||[]).map(i => ({ ...i, val: -i.value, type:'OUT' }))].sort((a,b) => { const dA = new Date(a.date || '9999-12-31'); const dB = new Date(b.date || '9999-12-31'); if (dA - dB !== 0) return dA - dB; return a.type === 'IN' ? -1 : 1; });
            let run = 0; document.getElementById('cashflow-content').innerHTML = `<table class="w-full text-left"><thead class="sticky top-0 bg-slate-800 text-[10px] uppercase text-slate-500"><tr><th class="p-3">Data</th><th>Descr.</th><th class="text-right">Valor</th></tr></thead><tbody>${entries.map(e=>{ run+=e.val; return `<tr class="border-b border-slate-700/50 text-[11px]"><td class="p-3 text-slate-500 font-mono">${e.date?new Date(e.date+'T00:00:00').toLocaleDateString('pt-BR'):'-'}</td><td class="font-bold text-slate-300">${e.name}</td><td class="text-right font-bold ${e.type==='IN'?'text-green-400':'text-red-400'}">${formatBRL(e.val)}</td></tr>`}).join('')}</tbody></table>`;
            document.getElementById('cashflow-title').innerText = `Fluxo: ${m.label}`; openModal('cashflow-modal-overlay');
        }
        function openChartModal() { openModal('chart-modal-overlay'); setTimeout(initChart, 100); }
        function initChart() {
            const ctx = document.getElementById('globalChart'); if(!ctx) return;
            const labels = timeline.map(m => m.label);
            const incs = timeline.map(m => (m.data.incomeEntries||[]).reduce((s, x) => s + (x.isCalculated ? (x.hours * x.rate) : (x.value || 0)), 0));
            const exps = timeline.map(m => (m.data.fixedExpensesEntries||[]).reduce((s, x) => s + (x.value || 0), 0) + (m.data.variableExpensesEntries||[]).reduce((s, x) => s + (x.value || 0), 0));
            if(globalChart) globalChart.destroy();
            globalChart = new Chart(ctx.getContext('2d'), { type: 'bar', data: { labels, datasets: [{ label: 'Renda', data: incs, backgroundColor: '#3b82f6' }, { label: 'Saídas', data: exps, backgroundColor: '#ef4444' }] }, options: { responsive: true, maintainAspectRatio: false } });
        }
        function copyPrev(mIdx, type) { if (mIdx === 0) return; const k = type==='income'?'incomeEntries':(type==='fixed'?'fixedExpensesEntries':'variableExpensesEntries'); const clean = JSON.parse(JSON.stringify(timeline[mIdx-1].data[k])).filter(x=>!x.isSystem).map(x=>({...x, id:Math.random(), isPaid:false})); if(type==='income'){ const sys = timeline[mIdx].data.incomeEntries.find(x=>x.isSystem); timeline[mIdx].data.incomeEntries = [sys, ...clean]; } else { timeline[mIdx].data[k] = clean; } saveData(); propagateBalances(); refreshUI(); }
        function advanceTimeline() { customConfirm("Encerrar Mês?", "O mês mais antigo será removido da vista.", () => { timeline.shift(); if(timeline.length < 1) createInitialTimeline(); else { const last = timeline[timeline.length - 1]; let nIdx = (MONTH_NAMES.indexOf(last.label) + 1) % 12; let nYear = nIdx === 0 ? last.year + 1 : last.year; timeline.push({ label: MONTH_NAMES[nIdx], year: nYear, bank1Name: last.bank1Name, bank2Name: last.bank2Name, bank1Balance: 0, bank2Balance: 0, data: createEmptyMonthData(nIdx, nYear) }); } saveData(); propagateBalances(); location.reload(); }); }
        function addNewMonthManual() { const last = timeline[timeline.length - 1]; let nextMIdx = (MONTH_NAMES.indexOf(last.label) + 1) % 12; let nextYear = nextMIdx === 0 ? last.year + 1 : last.year; timeline.push({ label: MONTH_NAMES[nextMIdx], year: nextYear, bank1Name: last.bank1Name, bank2Name: last.bank2Name, bank1Balance: 0, bank2Balance: 0, data: createEmptyMonthData(nextMIdx, nextYear) }); propagateBalances(); activeIndex = timeline.length - 1; renderAll(); saveData(); }
        function exportCurrentMonthCSV() { const m = timeline[activeIndex]; let csv = "Tipo;Data;Descricao;Valor;Status\n"; const add = (t, l) => (l||[]).forEach(i => csv += `${t};${i.date || ''};${i.name};${i.value || 0};${i.isPaid ? 'Pago' : 'Pendente'}\n`); add('Entrada', m.data.incomeEntries); add('Fixa', m.data.fixedExpensesEntries); add('Variavel', m.data.variableExpensesEntries); const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' })); a.download = `planilha_${m.label}.csv`; a.click(); }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
